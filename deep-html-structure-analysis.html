<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±åº¦HTMLç»“æ„åˆ†æ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .test-button {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-size: 11px;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }

        .result.success {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid rgba(34, 197, 94, 0.6);
        }

        .result.error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.6);
        }

        .result.info {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.6);
        }

        .file-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            text-align: center;
        }

        .dom-tree {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            line-height: 1.2;
        }

        .dom-level-0 { margin-left: 0px; color: #ff6b6b; }
        .dom-level-1 { margin-left: 20px; color: #4ecdc4; }
        .dom-level-2 { margin-left: 40px; color: #45b7d1; }
        .dom-level-3 { margin-left: 60px; color: #96ceb4; }
        .dom-level-4 { margin-left: 80px; color: #feca57; }
        .dom-level-5 { margin-left: 100px; color: #ff9ff3; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”¬ æ·±åº¦HTMLç»“æ„åˆ†æ</h1>
        <p>åˆ†æä¹¦ç­¾HTMLçš„çœŸå®DOMç»“æ„ï¼Œæ‰¾å‡ºè·¯å¾„æå–å¤±è´¥çš„æ ¹æœ¬åŸå› </p>
    </div>

    <div class="test-section">
        <h3>ğŸ“ HTMLç»“æ„æ·±åº¦åˆ†æ</h3>
        <div class="file-input">
            <input type="file" id="bookmark-file" accept=".html" onchange="analyzeHTMLStructure(event)">
            <p>é€‰æ‹©ä½ çš„ bookmarks_2025-06-27.html æ–‡ä»¶</p>
        </div>
        <button class="test-button" onclick="analyzeKnownStructure()">åˆ†æå·²çŸ¥ç»“æ„</button>
        <div id="structure-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ¯ DOMéå†è·¯å¾„åˆ†æ</h3>
        <button class="test-button" onclick="analyzeDOMTraversal()">åˆ†æDOMéå†è·¯å¾„</button>
        <div id="traversal-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ”§ æ–°ç®—æ³•æµ‹è¯•</h3>
        <button class="test-button" onclick="testNewAlgorithm()">æµ‹è¯•æ–°è·¯å¾„æå–ç®—æ³•</button>
        <div id="algorithm-result" class="result" style="display:none;"></div>
    </div>

    <script>
        let globalDoc = null;

        // åˆ†æHTMLç»“æ„
        async function analyzeHTMLStructure(event) {
            const resultDiv = document.getElementById('structure-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ğŸ”„ åˆ†æHTMLç»“æ„...';
            resultDiv.className = 'result info';

            try {
                const file = event.target.files[0];
                if (!file) return;

                const content = await readFileContent(file);
                const parser = new DOMParser();
                const doc = parser.parseFromString(content, 'text/html');
                globalDoc = doc;

                let analysis = `HTMLç»“æ„æ·±åº¦åˆ†æ\n`;
                analysis += `==================\n\n`;
                analysis += `æ–‡ä»¶: ${file.name}\n`;
                analysis += `å¤§å°: ${file.size} å­—èŠ‚\n\n`;

                // åˆ†ææ ¹çº§å…ƒç´ 
                const body = doc.body || doc.documentElement;
                analysis += `æ ¹å…ƒç´ åˆ†æ:\n`;
                analysis += `- æ ¹å…ƒç´ : ${body.tagName}\n`;
                analysis += `- ç›´æ¥å­å…ƒç´ æ•°é‡: ${body.children.length}\n\n`;

                // åˆ†æDLç»“æ„
                const allDLs = doc.querySelectorAll('dl');
                const allDTs = doc.querySelectorAll('dt');
                const allH3s = doc.querySelectorAll('h3');
                const allLinks = doc.querySelectorAll('a[href]');

                analysis += `å…ƒç´ ç»Ÿè®¡:\n`;
                analysis += `- DLå…ƒç´ : ${allDLs.length} ä¸ª\n`;
                analysis += `- DTå…ƒç´ : ${allDTs.length} ä¸ª\n`;
                analysis += `- H3å…ƒç´ : ${allH3s.length} ä¸ª\n`;
                analysis += `- é“¾æ¥å…ƒç´ : ${allLinks.length} ä¸ª\n\n`;

                // åˆ†æå‰5ä¸ªé“¾æ¥çš„DOMè·¯å¾„
                analysis += `å‰5ä¸ªé“¾æ¥çš„DOMè·¯å¾„åˆ†æ:\n`;
                analysis += `${'='.repeat(50)}\n`;

                const links = Array.from(allLinks).filter(link => 
                    link.href && link.href.startsWith('http')
                ).slice(0, 5);

                links.forEach((link, index) => {
                    analysis += `\n${index + 1}. é“¾æ¥: "${link.textContent.trim()}"\n`;
                    analysis += `   URL: ${link.href}\n`;
                    analysis += `   DOMè·¯å¾„:\n`;
                    
                    // åˆ†æå®Œæ•´çš„DOMè·¯å¾„
                    const path = [];
                    let current = link;
                    let level = 0;
                    
                    while (current && current !== doc.documentElement && level < 10) {
                        const tagInfo = `${current.tagName}${current.id ? '#' + current.id : ''}${current.className ? '.' + current.className.split(' ').join('.') : ''}`;
                        path.unshift(`${'  '.repeat(level)}${tagInfo}`);
                        
                        // åˆ†æå…„å¼Ÿå…ƒç´ 
                        if (current.tagName === 'DT') {
                            analysis += `     DTå…ƒç´ åˆ†æ:\n`;
                            analysis += `       - çˆ¶å…ƒç´ : ${current.parentElement ? current.parentElement.tagName : 'null'}\n`;
                            analysis += `       - å‰ä¸€ä¸ªå…„å¼Ÿ: ${current.previousElementSibling ? current.previousElementSibling.tagName : 'null'}\n`;
                            analysis += `       - åä¸€ä¸ªå…„å¼Ÿ: ${current.nextElementSibling ? current.nextElementSibling.tagName : 'null'}\n`;
                        }
                        
                        if (current.tagName === 'DL') {
                            analysis += `     DLå…ƒç´ åˆ†æ:\n`;
                            analysis += `       - çˆ¶å…ƒç´ : ${current.parentElement ? current.parentElement.tagName : 'null'}\n`;
                            analysis += `       - å‰ä¸€ä¸ªå…„å¼Ÿ: ${current.previousElementSibling ? current.previousElementSibling.tagName : 'null'}\n`;
                            if (current.previousElementSibling && current.previousElementSibling.tagName === 'DT') {
                                const h3 = current.previousElementSibling.querySelector('h3');
                                if (h3) {
                                    analysis += `       - å‰ä¸€ä¸ªDTçš„H3: "${h3.textContent.trim()}"\n`;
                                }
                            }
                        }
                        
                        current = current.parentElement;
                        level++;
                    }
                    
                    analysis += `   å®Œæ•´è·¯å¾„:\n${path.join('\n')}\n`;
                });

                resultDiv.className = 'result info';
                resultDiv.innerHTML = analysis;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ åˆ†æå¤±è´¥: ${error.message}\n\nStack trace:\n${error.stack}`;
            }
        }

        // åˆ†æå·²çŸ¥ç»“æ„
        function analyzeKnownStructure() {
            const resultDiv = document.getElementById('structure-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ğŸ”„ åˆ†æå·²çŸ¥ç»“æ„...';
            resultDiv.className = 'result info';

            // ä½¿ç”¨æ ‡å‡†çš„Netscapeä¹¦ç­¾æ ¼å¼
            const testHTML = `<!DOCTYPE NETSCAPE-Bookmark-file-1>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>Bookmarks</TITLE>
<H1>Bookmarks</H1>
<DL><p>
<DT><H3>Untitled Folder</H3>
<DL><p>
  <DT><H3>æ”¶è—å¤¹æ </H3>
  <DL><p>
    <DT><H3>work-assist</H3>
    <DL><p>
      <DT><A HREF="https://aflowmind.com/app/mindmap/6E1-YDYVBAN4ORDO7PSH">AflowMind: The AI Mind Mapping Tool</A>
      <DT><A HREF="https://app.amymind.com/mindmap/new">AmyMind</A>
    </DL><p>
    <DT><H3>AI-Chat</H3>
    <DL><p>
      <DT><A HREF="https://chat.openai.com/chat">ChatGPT</A>
      <DT><A HREF="https://gemini.google.com/u/1/app/74a659aed20881f2">Gemini Advanced</A>
    </DL><p>
    <DT><A HREF="https://github.com/">GitHub (æ ¹çº§åˆ«)</A>
  </DL><p>
</DL><p>
</DL><p>`;

            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(testHTML, 'text/html');
                globalDoc = doc;

                let analysis = `å·²çŸ¥ç»“æ„åˆ†æ\n`;
                analysis += `==============\n\n`;

                // åˆ†æç¬¬ä¸€ä¸ªé“¾æ¥çš„è¯¦ç»†è·¯å¾„
                const aflowmindLink = doc.querySelector('a[href*="aflowmind"]');
                if (aflowmindLink) {
                    analysis += `AflowMindé“¾æ¥çš„è¯¦ç»†DOMåˆ†æ:\n`;
                    analysis += `é“¾æ¥æ–‡æœ¬: "${aflowmindLink.textContent.trim()}"\n\n`;

                    let current = aflowmindLink;
                    let step = 1;

                    while (current && current !== doc.documentElement) {
                        analysis += `æ­¥éª¤ ${step}: ${current.tagName}\n`;
                        
                        if (current.tagName === 'A') {
                            analysis += `  - è¿™æ˜¯ç›®æ ‡é“¾æ¥\n`;
                        } else if (current.tagName === 'DT') {
                            analysis += `  - è¿™æ˜¯åŒ…å«é“¾æ¥çš„DT\n`;
                            analysis += `  - çˆ¶å…ƒç´ : ${current.parentElement ? current.parentElement.tagName : 'null'}\n`;
                        } else if (current.tagName === 'DL') {
                            analysis += `  - è¿™æ˜¯åŒ…å«DTçš„DL\n`;
                            analysis += `  - å‰ä¸€ä¸ªå…„å¼Ÿ: ${current.previousElementSibling ? current.previousElementSibling.tagName : 'null'}\n`;
                            
                            if (current.previousElementSibling && current.previousElementSibling.tagName === 'DT') {
                                const h3 = current.previousElementSibling.querySelector('h3');
                                if (h3) {
                                    analysis += `  - å‰ä¸€ä¸ªDTåŒ…å«H3: "${h3.textContent.trim()}"\n`;
                                } else {
                                    analysis += `  - å‰ä¸€ä¸ªDTä¸åŒ…å«H3\n`;
                                }
                            }
                        }
                        
                        current = current.parentElement;
                        step++;
                        
                        if (step > 10) break; // é˜²æ­¢æ— é™å¾ªç¯
                    }
                }

                resultDiv.className = 'result info';
                resultDiv.innerHTML = analysis;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ åˆ†æå¤±è´¥: ${error.message}`;
            }
        }

        // åˆ†æDOMéå†è·¯å¾„
        function analyzeDOMTraversal() {
            const resultDiv = document.getElementById('traversal-result');
            resultDiv.style.display = 'block';

            if (!globalDoc) {
                resultDiv.innerHTML = 'âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶è¿›è¡Œåˆ†æ';
                resultDiv.className = 'result error';
                return;
            }

            resultDiv.innerHTML = 'ğŸ”„ åˆ†æDOMéå†è·¯å¾„...';
            resultDiv.className = 'result info';

            try {
                let analysis = `DOMéå†è·¯å¾„åˆ†æ\n`;
                analysis += `================\n\n`;

                const links = Array.from(globalDoc.querySelectorAll('a[href]')).filter(link => 
                    link.href && link.href.startsWith('http')
                ).slice(0, 3);

                links.forEach((link, index) => {
                    analysis += `${index + 1}. é“¾æ¥: "${link.textContent.trim()}"\n`;
                    analysis += `éå†è·¯å¾„:\n`;

                    // æ–°çš„éå†ç®—æ³•
                    const path = getBookmarkPathNew(link);
                    analysis += `æå–çš„è·¯å¾„: [${path.join(' > ')}]\n`;

                    // è¯¦ç»†çš„éå†æ­¥éª¤
                    analysis += `è¯¦ç»†éå†æ­¥éª¤:\n`;
                    let current = link.closest('dt');
                    let stepNum = 1;

                    while (current && stepNum <= 10) {
                        analysis += `  æ­¥éª¤${stepNum}: å½“å‰å…ƒç´  ${current.tagName}\n`;
                        
                        const parentDL = current.parentElement;
                        if (parentDL && parentDL.tagName === 'DL') {
                            analysis += `    - çˆ¶DLæ‰¾åˆ°\n`;
                            
                            let folderDT = parentDL.previousElementSibling;
                            while (folderDT && folderDT.nodeType !== Node.ELEMENT_NODE) {
                                folderDT = folderDT.previousSibling;
                            }
                            
                            if (folderDT && folderDT.tagName === 'DT') {
                                analysis += `    - å‰ä¸€ä¸ªDTæ‰¾åˆ°\n`;
                                const folderH3 = folderDT.querySelector('h3');
                                if (folderH3) {
                                    const folderName = folderH3.textContent.trim();
                                    analysis += `    - H3æ‰¾åˆ°: "${folderName}"\n`;
                                } else {
                                    analysis += `    - H3æœªæ‰¾åˆ°\n`;
                                }
                            } else {
                                analysis += `    - å‰ä¸€ä¸ªDTæœªæ‰¾åˆ°\n`;
                            }
                            
                            current = folderDT;
                        } else {
                            analysis += `    - çˆ¶DLæœªæ‰¾åˆ°ï¼Œåœæ­¢éå†\n`;
                            break;
                        }
                        
                        stepNum++;
                    }
                    
                    analysis += `\n`;
                });

                resultDiv.className = 'result info';
                resultDiv.innerHTML = analysis;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ éå†åˆ†æå¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•æ–°ç®—æ³•
        function testNewAlgorithm() {
            const resultDiv = document.getElementById('algorithm-result');
            resultDiv.style.display = 'block';

            if (!globalDoc) {
                resultDiv.innerHTML = 'âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶è¿›è¡Œåˆ†æ';
                resultDiv.className = 'result error';
                return;
            }

            resultDiv.innerHTML = 'ğŸ”„ æµ‹è¯•æ–°ç®—æ³•...';
            resultDiv.className = 'result info';

            try {
                let analysis = `æ–°ç®—æ³•æµ‹è¯•ç»“æœ\n`;
                analysis += `================\n\n`;

                const links = Array.from(globalDoc.querySelectorAll('a[href]')).filter(link => 
                    link.href && link.href.startsWith('http')
                ).slice(0, 10);

                analysis += `æµ‹è¯• ${links.length} ä¸ªé“¾æ¥:\n\n`;

                links.forEach((link, index) => {
                    const title = link.textContent.trim();
                    const path = getBookmarkPathNew(link);
                    
                    analysis += `${index + 1}. ${title}\n`;
                    analysis += `   è·¯å¾„: [${path.join(' > ')}]\n`;
                    
                    if (path.length > 0) {
                        analysis += `   âœ… æˆåŠŸæå–è·¯å¾„\n`;
                    } else {
                        analysis += `   âŒ è·¯å¾„æå–å¤±è´¥\n`;
                    }
                    analysis += `\n`;
                });

                // ç»Ÿè®¡ç»“æœ
                const successCount = links.filter(link => getBookmarkPathNew(link).length > 0).length;
                const totalCount = links.length;

                analysis += `ç»Ÿè®¡ç»“æœ:\n`;
                analysis += `- æˆåŠŸæå–: ${successCount}/${totalCount}\n`;
                analysis += `- æˆåŠŸç‡: ${((successCount / totalCount) * 100).toFixed(1)}%\n`;

                if (successCount > 0) {
                    analysis += `\nâœ… æ–°ç®—æ³•å·¥ä½œæ­£å¸¸ï¼`;
                    resultDiv.className = 'result success';
                } else {
                    analysis += `\nâŒ æ–°ç®—æ³•ä»éœ€æ”¹è¿›ã€‚`;
                    resultDiv.className = 'result error';
                }

                resultDiv.innerHTML = analysis;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ ç®—æ³•æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // æ–°çš„è·¯å¾„æå–ç®—æ³•
        function getBookmarkPathNew(linkElement) {
            const path = [];
            let current = linkElement.closest('dt');
            
            while (current) {
                const parentDL = current.parentElement;
                
                if (parentDL && parentDL.tagName === 'DL') {
                    // æŸ¥æ‰¾è¿™ä¸ªDLå¯¹åº”çš„æ–‡ä»¶å¤¹DT
                    let folderDT = parentDL.previousElementSibling;
                    
                    // è·³è¿‡ç©ºç™½æ–‡æœ¬èŠ‚ç‚¹
                    while (folderDT && folderDT.nodeType !== Node.ELEMENT_NODE) {
                        folderDT = folderDT.previousSibling;
                    }
                    
                    if (folderDT && folderDT.tagName === 'DT') {
                        const folderH3 = folderDT.querySelector('h3');
                        if (folderH3) {
                            const folderName = folderH3.textContent.trim();
                            if (folderName !== 'Untitled Folder') {
                                path.unshift(folderName);
                            }
                        }
                    }
                    
                    // ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾
                    current = folderDT;
                } else {
                    // æ²¡æœ‰æ›´å¤šçˆ¶çº§DLï¼Œåœæ­¢æŸ¥æ‰¾
                    break;
                }
            }
            
            return path;
        }

        // è¾…åŠ©å‡½æ•°
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsText(file, 'UTF-8');
            });
        }
    </script>
</body>
</html>
