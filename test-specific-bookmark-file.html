<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•ç‰¹å®šä¹¦ç­¾æ–‡ä»¶è§£æ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .test-button {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        .result.success {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid rgba(34, 197, 94, 0.6);
        }

        .result.error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.6);
        }

        .result.info {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.6);
        }

        .file-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” æµ‹è¯•ç‰¹å®šä¹¦ç­¾æ–‡ä»¶è§£æ</h1>
        <p>ä¸“é—¨æµ‹è¯• bookmarks_2025-06-27.html æ–‡ä»¶çš„è§£æé—®é¢˜</p>
    </div>

    <div class="test-section">
        <h3>ğŸ“ é€‰æ‹©ä¹¦ç­¾æ–‡ä»¶è¿›è¡Œæµ‹è¯•</h3>
        <div class="file-input">
            <input type="file" id="bookmark-file" accept=".html" onchange="testBookmarkParsing(event)">
            <p>è¯·é€‰æ‹© bookmarks_2025-06-27.html æ–‡ä»¶</p>
        </div>
        <button class="test-button" onclick="testWithSampleData()">ä½¿ç”¨ç¤ºä¾‹æ•°æ®æµ‹è¯•</button>
        <div id="parse-result" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª è§£æç»“æœåˆ†æ</h3>
        <div id="analysis-result" class="result" style="display:none;"></div>
    </div>

    <script>
        // æµ‹è¯•ä¹¦ç­¾è§£æ
        async function testBookmarkParsing(event) {
            const resultDiv = document.getElementById('parse-result');
            const analysisDiv = document.getElementById('analysis-result');
            
            resultDiv.style.display = 'block';
            analysisDiv.style.display = 'block';
            
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨è§£æä¹¦ç­¾æ–‡ä»¶...';
            resultDiv.className = 'result info';

            try {
                const file = event.target.files[0];
                if (!file) {
                    resultDiv.innerHTML = 'âŒ è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶';
                    resultDiv.className = 'result error';
                    return;
                }

                // è¯»å–æ–‡ä»¶
                const content = await readFileContent(file);
                console.log('ğŸ“„ æ–‡ä»¶å†…å®¹é•¿åº¦:', content.length);
                
                // è§£æHTML
                const bookmarks = parseBookmarkHTML(content);

                let output = `ğŸ“Š è§£æç»“æœç»Ÿè®¡:\n\n`;
                output += `æ–‡ä»¶å: ${file.name}\n`;
                output += `æ–‡ä»¶å¤§å°: ${file.size} å­—èŠ‚\n`;
                output += `è§£æåˆ°çš„é¡¹ç›®æ€»æ•°: ${bookmarks.length}\n\n`;

                // ç»Ÿè®¡ç±»å‹
                const typeCount = {};
                bookmarks.forEach(bookmark => {
                    const type = bookmark.type || 'unknown';
                    typeCount[type] = (typeCount[type] || 0) + 1;
                });

                output += `ç±»å‹åˆ†å¸ƒ:\n`;
                Object.entries(typeCount).forEach(([type, count]) => {
                    output += `- ${type}: ${count} ä¸ª\n`;
                });

                // æ˜¾ç¤ºå‰20ä¸ªé¡¹ç›®
                output += `\nå‰20ä¸ªè§£æé¡¹ç›®:\n`;
                bookmarks.slice(0, 20).forEach((bookmark, index) => {
                    const pathStr = bookmark.path.length > 0 ? ` (è·¯å¾„: ${bookmark.path.join(' > ')})` : '';
                    output += `${index + 1}. [${bookmark.type}] ${bookmark.title}${pathStr}\n`;
                    if (bookmark.url) {
                        output += `   URL: ${bookmark.url.substring(0, 80)}${bookmark.url.length > 80 ? '...' : ''}\n`;
                    }
                });

                if (bookmarks.length > 20) {
                    output += `\n... è¿˜æœ‰ ${bookmarks.length - 20} ä¸ªé¡¹ç›®`;
                }

                resultDiv.className = 'result success';
                resultDiv.innerHTML = output;

                // åˆ†æç»“æœ
                analyzeResults(bookmarks, analysisDiv);

            } catch (error) {
                console.error('âŒ è§£æå¤±è´¥:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è§£æå¤±è´¥: ${error.message}`;
            }
        }

        // åˆ†æè§£æç»“æœ
        function analyzeResults(bookmarks, analysisDiv) {
            let analysis = `ğŸ” æ·±åº¦åˆ†æ:\n\n`;

            // æ£€æŸ¥æ˜¯å¦æœ‰ä¹¦ç­¾
            const bookmarkItems = bookmarks.filter(b => b.type === 'bookmark');
            const folderItems = bookmarks.filter(b => b.type === 'folder');

            analysis += `ä¹¦ç­¾æ•°é‡: ${bookmarkItems.length}\n`;
            analysis += `æ–‡ä»¶å¤¹æ•°é‡: ${folderItems.length}\n\n`;

            if (bookmarkItems.length === 0) {
                analysis += `âŒ é—®é¢˜: æ²¡æœ‰è§£æåˆ°ä»»ä½•ä¹¦ç­¾ï¼\n`;
                analysis += `è¿™å¯èƒ½æ˜¯è§£æé€»è¾‘çš„é—®é¢˜ã€‚\n\n`;
            } else if (bookmarkItems.length === 1) {
                analysis += `âš ï¸ é—®é¢˜: åªè§£æåˆ°1ä¸ªä¹¦ç­¾ï¼\n`;
                analysis += `è¿™æ­£æ˜¯æˆ‘ä»¬è¦è§£å†³çš„é—®é¢˜ã€‚\n\n`;
            } else {
                analysis += `âœ… è§£æåˆ°å¤šä¸ªä¹¦ç­¾ï¼Œçœ‹èµ·æ¥æ­£å¸¸ã€‚\n\n`;
            }

            // åˆ†æè·¯å¾„åˆ†å¸ƒ
            const pathDistribution = {};
            bookmarkItems.forEach(bookmark => {
                const pathKey = bookmark.path.join(' > ') || 'æ ¹ç›®å½•';
                pathDistribution[pathKey] = (pathDistribution[pathKey] || 0) + 1;
            });

            analysis += `ä¹¦ç­¾è·¯å¾„åˆ†å¸ƒ:\n`;
            Object.entries(pathDistribution).forEach(([path, count]) => {
                analysis += `- ${path}: ${count} ä¸ªä¹¦ç­¾\n`;
            });

            // æ£€æŸ¥ç‰¹å®šçš„æ–‡ä»¶å¤¹
            const workAssistFolder = bookmarkItems.filter(b => 
                b.path.includes('work-assist') || b.path.includes('æ”¶è—å¤¹æ ')
            );
            
            if (workAssistFolder.length > 0) {
                analysis += `\nâœ… æ‰¾åˆ° work-assist æˆ–æ”¶è—å¤¹æ ç›¸å…³ä¹¦ç­¾: ${workAssistFolder.length} ä¸ª\n`;
            } else {
                analysis += `\nâŒ æœªæ‰¾åˆ° work-assist æˆ–æ”¶è—å¤¹æ ç›¸å…³ä¹¦ç­¾\n`;
            }

            // æ£€æŸ¥AI-Chatæ–‡ä»¶å¤¹
            const aiChatFolder = bookmarkItems.filter(b => 
                b.path.includes('AI-Chat')
            );
            
            if (aiChatFolder.length > 0) {
                analysis += `âœ… æ‰¾åˆ° AI-Chat ç›¸å…³ä¹¦ç­¾: ${aiChatFolder.length} ä¸ª\n`;
            } else {
                analysis += `âŒ æœªæ‰¾åˆ° AI-Chat ç›¸å…³ä¹¦ç­¾\n`;
            }

            analysisDiv.className = 'result info';
            analysisDiv.innerHTML = analysis;
        }

        // ä½¿ç”¨ç¤ºä¾‹æ•°æ®æµ‹è¯•
        function testWithSampleData() {
            const resultDiv = document.getElementById('parse-result');
            const analysisDiv = document.getElementById('analysis-result');
            
            resultDiv.style.display = 'block';
            analysisDiv.style.display = 'block';
            
            // æ¨¡æ‹Ÿä¹¦ç­¾æ–‡ä»¶çš„å…³é”®éƒ¨åˆ†
            const sampleHTML = `<!DOCTYPE NETSCAPE-Bookmark-file-1>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>Bookmarks</TITLE>
<H1>Bookmarks</H1>
<DL><p>
<DT><H3>Untitled Folder</H3>
<DL><p>
  <DT><H3>æ”¶è—å¤¹æ </H3>
  <DL><p>
    <DT><H3>work-assist</H3>
    <DL><p>
      <DT><A HREF="https://aflowmind.com/app/mindmap/6E1-YDYVBAN4ORDO7PSH">AflowMind: The AI Mind Mapping Tool</A>
      <DT><A HREF="https://app.amymind.com/mindmap/new">AmyMind</A>
      <DT><A HREF="https://github.com/SonarSource/sonarqube-roslyn-sdk">SonarSource/sonarqube-roslyn-sdk</A>
    </DL><p>
    <DT><H3>AI-Chat</H3>
    <DL><p>
      <DT><A HREF="https://chat.openai.com/chat">ChatGPT</A>
      <DT><A HREF="https://gemini.google.com/u/1/app/74a659aed20881f2">Gemini Advanced</A>
      <DT><A HREF="https://aistudio.google.com/prompts/new_chat">Google AI Studio</A>
    </DL><p>
  </DL><p>
</DL><p>
</DL><p>`;

            try {
                const bookmarks = parseBookmarkHTML(sampleHTML);
                
                let output = `ğŸ“Š ç¤ºä¾‹æ•°æ®è§£æç»“æœ:\n\n`;
                output += `è§£æåˆ°çš„é¡¹ç›®æ€»æ•°: ${bookmarks.length}\n\n`;

                bookmarks.forEach((bookmark, index) => {
                    const pathStr = bookmark.path.length > 0 ? ` (è·¯å¾„: ${bookmark.path.join(' > ')})` : '';
                    output += `${index + 1}. [${bookmark.type}] ${bookmark.title}${pathStr}\n`;
                    if (bookmark.url) {
                        output += `   URL: ${bookmark.url}\n`;
                    }
                });

                resultDiv.className = 'result success';
                resultDiv.innerHTML = output;

                analyzeResults(bookmarks, analysisDiv);

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ ç¤ºä¾‹æ•°æ®è§£æå¤±è´¥: ${error.message}`;
            }
        }

        // è¾…åŠ©å‡½æ•°
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        // ä¿®å¤åçš„è§£æå‡½æ•°ï¼ˆå¤åˆ¶è‡ªbookmarks.jsçš„ä¿®å¤ç‰ˆæœ¬ï¼‰
        function parseBookmarkHTML(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');

            const bookmarks = [];

            const processElement = (element, parentPath = []) => {
                if (!element || !element.children) return;
                
                const children = Array.from(element.children);
                console.log(`ğŸ” å¤„ç†å…ƒç´ : ${element.tagName}, å­å…ƒç´ æ•°é‡: ${children.length}, è·¯å¾„: ${parentPath.join(' > ')}`);

                for (let i = 0; i < children.length; i++) {
                    const child = children[i];
                    console.log(`ğŸ“ å¤„ç†å­å…ƒç´  ${i + 1}/${children.length}: ${child.tagName}`);
                    
                    if (child.tagName === 'DT') {
                        const link = child.querySelector('a');
                        const folder = child.querySelector('h3');

                        if (link && link.href) {
                            // è¿™æ˜¯ä¸€ä¸ªä¹¦ç­¾
                            const bookmark = {
                                type: 'bookmark',
                                title: link.textContent.trim() || 'Untitled',
                                url: link.href,
                                path: [...parentPath]
                            };
                            bookmarks.push(bookmark);
                            console.log(`ğŸ“– æ‰¾åˆ°ä¹¦ç­¾: ${bookmark.title}, è·¯å¾„: ${parentPath.join(' > ')}`);
                        } else if (folder) {
                            // è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹
                            const folderName = folder.textContent.trim() || 'Untitled Folder';
                            
                            // è·³è¿‡æŸäº›ç³»ç»Ÿæ–‡ä»¶å¤¹
                            if (folderName === 'Untitled Folder' && parentPath.length === 0) {
                                console.log(`â­ï¸ è·³è¿‡æ ¹çº§åˆ«çš„ Untitled Folder`);
                                // ç›´æ¥å¤„ç†è¿™ä¸ªDTä¸‹çš„DLå†…å®¹ï¼Œä½†ä¸åˆ›å»ºæ–‡ä»¶å¤¹
                                const dl = child.querySelector('dl');
                                if (dl) {
                                    console.log(`ğŸ”„ ç›´æ¥å¤„ç† Untitled Folder å†…å®¹`);
                                    processElement(dl, parentPath); // ä¸å¢åŠ è·¯å¾„å±‚çº§
                                }
                                continue;
                            }

                            const folderPath = [...parentPath, folderName];

                            bookmarks.push({
                                type: 'folder',
                                title: folderName,
                                path: [...parentPath]
                            });
                            console.log(`ğŸ“ æ‰¾åˆ°æ–‡ä»¶å¤¹: ${folderName}, è·¯å¾„: ${parentPath.join(' > ')}`);

                            // æŸ¥æ‰¾æ–‡ä»¶å¤¹å†…å®¹
                            let foundDL = null;
                            
                            // æ–¹å¼1: æŸ¥æ‰¾ç´§è·Ÿåœ¨DTåé¢çš„DL
                            const nextSibling = child.nextElementSibling;
                            if (nextSibling && nextSibling.tagName === 'DL') {
                                foundDL = nextSibling;
                                console.log(`âœ… æ–¹å¼1: æ‰¾åˆ°ç´§è·Ÿçš„DL`);
                            }
                            
                            // æ–¹å¼2: æŸ¥æ‰¾DTå†…éƒ¨çš„DL
                            if (!foundDL) {
                                const dl = child.querySelector('dl');
                                if (dl) {
                                    foundDL = dl;
                                    console.log(`âœ… æ–¹å¼2: æ‰¾åˆ°å†…éƒ¨DL`);
                                }
                            }

                            if (foundDL) {
                                console.log(`ğŸ”„ é€’å½’å¤„ç†æ–‡ä»¶å¤¹å†…å®¹: ${folderName}`);
                                processElement(foundDL, folderPath);
                            } else {
                                console.log(`âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶å¤¹ ${folderName} çš„å†…å®¹DL`);
                            }
                        }
                    } else if (child.tagName === 'DL') {
                        // ç›´æ¥å¤„ç†DLå…ƒç´ 
                        console.log(`ğŸ”„ é€’å½’å¤„ç†ç›´æ¥çš„DLå…ƒç´ `);
                        processElement(child, parentPath);
                    }
                }
            };

            // ä»æ ¹DLå…ƒç´ å¼€å§‹å¤„ç†
            const rootDL = doc.querySelector('dl');
            if (rootDL) {
                console.log(`ğŸš€ å¼€å§‹ä»æ ¹DLè§£æ`);
                processElement(rootDL);
            } else {
                console.log(`âš ï¸ æœªæ‰¾åˆ°æ ¹DLå…ƒç´ `);
            }

            console.log(`ğŸ“Š è§£æå®Œæˆï¼Œæ€»å…±æ‰¾åˆ° ${bookmarks.length} ä¸ªé¡¹ç›®`);
            return bookmarks;
        }
    </script>
</body>
</html>
