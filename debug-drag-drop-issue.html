<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹–æ”¾é—®é¢˜è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .test-button {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }

        .result.success {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid rgba(34, 197, 94, 0.6);
        }

        .result.error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid rgba(239, 68, 68, 0.6);
        }

        .result.info {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.6);
        }

        .drag-demo {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .drag-item {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: move;
            user-select: none;
            transition: all 0.3s ease;
            position: relative;
        }

        .drag-item:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .drag-item.dragging {
            opacity: 0.5;
        }

        .insert-line {
            position: absolute;
            width: 3px;
            background: #22c55e;
            border-radius: 2px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .insert-line.visible {
            opacity: 1;
        }

        .problem-analysis {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .solution-box {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ› æ‹–æ”¾é—®é¢˜è°ƒè¯•å·¥å…·</h1>
        <p>åˆ†æå’Œä¿®å¤ä»å³åˆ°å·¦æ‹–åŠ¨å¤±è´¥çš„é—®é¢˜</p>
    </div>

    <!-- é—®é¢˜åˆ†æ -->
    <div class="test-section">
        <h3>ğŸ” é—®é¢˜åˆ†æ</h3>
        <div class="problem-analysis">
            <h4>å‘ç°çš„é—®é¢˜ï¼š</h4>
            <p>1. <strong>ç´¢å¼•è®¡ç®—é”™è¯¯</strong>ï¼šä»å³åˆ°å·¦æ‹–åŠ¨æ—¶ï¼Œç›®æ ‡ç´¢å¼•è®¡ç®—ä¸æ­£ç¡®</p>
            <p>2. <strong>æ’å…¥ä½ç½®åˆ¤æ–­</strong>ï¼šinsertBefore é€»è¾‘åœ¨æŸäº›æƒ…å†µä¸‹å¤±æ•ˆ</p>
            <p>3. <strong>åŒçº§ç§»åŠ¨è°ƒæ•´</strong>ï¼šå½“åœ¨åŒä¸€çˆ¶çº§å†…ç§»åŠ¨æ—¶ï¼Œç´¢å¼•è°ƒæ•´é€»è¾‘æœ‰ç¼ºé™·</p>
        </div>
        
        <button class="test-button" onclick="analyzeIndexCalculation()">åˆ†æç´¢å¼•è®¡ç®—é—®é¢˜</button>
        <div id="analysis-result" class="result" style="display:none;"></div>
    </div>

    <!-- æ‹–æ”¾æ¨¡æ‹Ÿ -->
    <div class="test-section">
        <h3>ğŸ¯ æ‹–æ”¾è¡Œä¸ºæ¨¡æ‹Ÿ</h3>
        <p>æ¨¡æ‹Ÿä¸åŒæ–¹å‘çš„æ‹–æ”¾æ“ä½œï¼Œæµ‹è¯•ç´¢å¼•è®¡ç®—</p>
        
        <div class="drag-demo" id="drag-demo">
            <div class="drag-item" data-index="0">Item A</div>
            <div class="drag-item" data-index="1">Item B</div>
            <div class="drag-item" data-index="2">Item C</div>
            <div class="drag-item" data-index="3">Item D</div>
            <div class="drag-item" data-index="4">Item E</div>
        </div>
        
        <button class="test-button" onclick="simulateLeftToRight()">æ¨¡æ‹Ÿä»å·¦åˆ°å³æ‹–åŠ¨</button>
        <button class="test-button" onclick="simulateRightToLeft()">æ¨¡æ‹Ÿä»å³åˆ°å·¦æ‹–åŠ¨</button>
        <button class="test-button" onclick="resetDemo()">é‡ç½®æ¼”ç¤º</button>
        
        <div id="simulation-result" class="result" style="display:none;"></div>
    </div>

    <!-- ä¿®å¤æ–¹æ¡ˆ -->
    <div class="test-section">
        <h3>ğŸ”§ ä¿®å¤æ–¹æ¡ˆ</h3>
        <div class="solution-box">
            <h4>ä¿®å¤ç­–ç•¥ï¼š</h4>
            <p>1. <strong>æ”¹è¿›ç´¢å¼•è®¡ç®—</strong>ï¼šæ­£ç¡®å¤„ç†ä»å³åˆ°å·¦çš„æ‹–åŠ¨</p>
            <p>2. <strong>ä¼˜åŒ–æ’å…¥é€»è¾‘</strong>ï¼šç¡®ä¿ insertBefore åˆ¤æ–­å‡†ç¡®</p>
            <p>3. <strong>å¢å¼ºè°ƒè¯•æ—¥å¿—</strong>ï¼šæ·»åŠ è¯¦ç»†çš„æ‹–æ”¾è°ƒè¯•ä¿¡æ¯</p>
        </div>
        
        <button class="test-button" onclick="showFixedCode()">æ˜¾ç¤ºä¿®å¤ä»£ç </button>
        <div id="fix-result" class="result" style="display:none;"></div>
    </div>

    <div class="insert-line" id="insert-line"></div>

    <script>
        let draggedItem = null;
        let dragInsertInfo = null;

        // åˆ†æç´¢å¼•è®¡ç®—é—®é¢˜
        function analyzeIndexCalculation() {
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';

            let analysis = `ç´¢å¼•è®¡ç®—é—®é¢˜åˆ†æ\n`;
            analysis += `==================\n\n`;

            // æ¨¡æ‹Ÿä¸åŒçš„æ‹–æ”¾åœºæ™¯
            const scenarios = [
                {
                    name: "ä»å·¦åˆ°å³æ‹–åŠ¨ (A -> Dåé¢)",
                    draggedIndex: 0,
                    targetIndex: 3,
                    insertBefore: false,
                    expected: 3
                },
                {
                    name: "ä»å³åˆ°å·¦æ‹–åŠ¨ (D -> Aå‰é¢)",
                    draggedIndex: 3,
                    targetIndex: 0,
                    insertBefore: true,
                    expected: 0
                },
                {
                    name: "ä»å³åˆ°å·¦æ‹–åŠ¨ (E -> Båé¢)",
                    draggedIndex: 4,
                    targetIndex: 1,
                    insertBefore: false,
                    expected: 2
                },
                {
                    name: "ä»å·¦åˆ°å³æ‹–åŠ¨ (A -> Cå‰é¢)",
                    draggedIndex: 0,
                    targetIndex: 2,
                    insertBefore: true,
                    expected: 1
                }
            ];

            scenarios.forEach((scenario, index) => {
                analysis += `åœºæ™¯ ${index + 1}: ${scenario.name}\n`;
                analysis += `æ‹–åŠ¨é¡¹ç´¢å¼•: ${scenario.draggedIndex}\n`;
                analysis += `ç›®æ ‡é¡¹ç´¢å¼•: ${scenario.targetIndex}\n`;
                analysis += `æ’å…¥ä½ç½®: ${scenario.insertBefore ? 'å‰é¢' : 'åé¢'}\n`;

                // å½“å‰çš„é”™è¯¯è®¡ç®—
                const currentResult = calculateIndexOld(scenario);
                analysis += `å½“å‰è®¡ç®—ç»“æœ: ${currentResult}\n`;
                analysis += `æœŸæœ›ç»“æœ: ${scenario.expected}\n`;
                analysis += `ç»“æœ: ${currentResult === scenario.expected ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯'}\n\n`;

                // ä¿®å¤åçš„è®¡ç®—
                const fixedResult = calculateIndexFixed(scenario);
                analysis += `ä¿®å¤åè®¡ç®—: ${fixedResult}\n`;
                analysis += `ä¿®å¤ç»“æœ: ${fixedResult === scenario.expected ? 'âœ… æ­£ç¡®' : 'âŒ ä»æœ‰é—®é¢˜'}\n`;
                analysis += `${'='.repeat(50)}\n\n`;
            });

            resultDiv.innerHTML = analysis;
        }

        // å½“å‰çš„é”™è¯¯ç´¢å¼•è®¡ç®—é€»è¾‘
        function calculateIndexOld(scenario) {
            let targetIndex = scenario.targetIndex;

            // å¦‚æœæ’å…¥åˆ°åé¢ï¼Œç´¢å¼•+1
            if (!scenario.insertBefore) {
                targetIndex += 1;
            }

            // å¦‚æœæ‹–æ‹½é¡¹ç›®åœ¨ç›®æ ‡é¡¹ç›®å‰é¢ï¼Œéœ€è¦è°ƒæ•´ç´¢å¼•
            if (scenario.draggedIndex < targetIndex) {
                targetIndex -= 1;
            }

            return targetIndex;
        }

        // ä¿®å¤åçš„ç´¢å¼•è®¡ç®—é€»è¾‘
        function calculateIndexFixed(scenario) {
            let targetIndex = scenario.targetIndex;

            // å¦‚æœæ’å…¥åˆ°åé¢ï¼Œç´¢å¼•+1
            if (!scenario.insertBefore) {
                targetIndex += 1;
            }

            // å…³é”®ä¿®å¤ï¼šåªæœ‰å½“æ‹–åŠ¨é¡¹åœ¨ç›®æ ‡é¡¹å‰é¢ä¸”æœ€ç»ˆä½ç½®ä¹Ÿåœ¨ç›®æ ‡é¡¹å‰é¢æ—¶æ‰è°ƒæ•´
            if (scenario.draggedIndex < scenario.targetIndex && targetIndex > scenario.draggedIndex) {
                targetIndex -= 1;
            }

            return targetIndex;
        }

        // æ¨¡æ‹Ÿä»å·¦åˆ°å³æ‹–åŠ¨
        function simulateLeftToRight() {
            const resultDiv = document.getElementById('simulation-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';

            let result = `ä»å·¦åˆ°å³æ‹–åŠ¨æ¨¡æ‹Ÿ\n`;
            result += `==================\n\n`;
            result += `åœºæ™¯ï¼šå°† Item A (ç´¢å¼•0) æ‹–åŠ¨åˆ° Item D (ç´¢å¼•3) åé¢\n\n`;

            const scenario = {
                draggedIndex: 0,
                targetIndex: 3,
                insertBefore: false
            };

            result += `æ­¥éª¤åˆ†æï¼š\n`;
            result += `1. ç›®æ ‡ç´¢å¼•: ${scenario.targetIndex}\n`;
            result += `2. æ’å…¥åˆ°åé¢ï¼Œç´¢å¼•+1: ${scenario.targetIndex + 1}\n`;
            result += `3. æ‹–åŠ¨é¡¹åœ¨ç›®æ ‡é¡¹å‰é¢ï¼Œç´¢å¼•-1: ${scenario.targetIndex + 1 - 1}\n`;
            result += `4. æœ€ç»ˆç´¢å¼•: ${scenario.targetIndex}\n\n`;

            result += `é¢„æœŸç»“æœï¼šA åº”è¯¥å‡ºç°åœ¨ä½ç½® 3 (åŸDçš„ä½ç½®)\n`;
            result += `æ–°é¡ºåºï¼šB, C, D, A, E\n\n`;

            result += `âœ… ä»å·¦åˆ°å³æ‹–åŠ¨é€šå¸¸å·¥ä½œæ­£å¸¸`;

            resultDiv.innerHTML = result;
        }

        // æ¨¡æ‹Ÿä»å³åˆ°å·¦æ‹–åŠ¨
        function simulateRightToLeft() {
            const resultDiv = document.getElementById('simulation-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result error';

            let result = `ä»å³åˆ°å·¦æ‹–åŠ¨æ¨¡æ‹Ÿ\n`;
            result += `==================\n\n`;
            result += `åœºæ™¯ï¼šå°† Item E (ç´¢å¼•4) æ‹–åŠ¨åˆ° Item B (ç´¢å¼•1) å‰é¢\n\n`;

            const scenario = {
                draggedIndex: 4,
                targetIndex: 1,
                insertBefore: true
            };

            result += `å½“å‰é”™è¯¯è®¡ç®—ï¼š\n`;
            result += `1. ç›®æ ‡ç´¢å¼•: ${scenario.targetIndex}\n`;
            result += `2. æ’å…¥åˆ°å‰é¢ï¼Œç´¢å¼•ä¸å˜: ${scenario.targetIndex}\n`;
            result += `3. æ‹–åŠ¨é¡¹åœ¨ç›®æ ‡é¡¹åé¢ï¼Œä¸è°ƒæ•´: ${scenario.targetIndex}\n`;
            result += `4. æœ€ç»ˆç´¢å¼•: ${scenario.targetIndex}\n\n`;

            result += `âŒ é—®é¢˜ï¼šE è¢«æ”¾åˆ°äº†ä½ç½® 1ï¼Œä½†è¿™ä¼šæŠŠå®ƒæ”¾åœ¨ B çš„ä½ç½®ï¼Œè€Œä¸æ˜¯ B å‰é¢\n\n`;

            result += `ä¿®å¤åçš„è®¡ç®—ï¼š\n`;
            result += `1. ç›®æ ‡ç´¢å¼•: ${scenario.targetIndex}\n`;
            result += `2. æ’å…¥åˆ°å‰é¢ï¼Œç´¢å¼•ä¸å˜: ${scenario.targetIndex}\n`;
            result += `3. æ‹–åŠ¨é¡¹åœ¨ç›®æ ‡é¡¹åé¢ï¼Œä¸”ç›®æ ‡ä½ç½®åœ¨æ‹–åŠ¨é¡¹å‰é¢ï¼Œä¸éœ€è¦è°ƒæ•´\n`;
            result += `4. æœ€ç»ˆç´¢å¼•: ${scenario.targetIndex}\n\n`;

            result += `âœ… ä¿®å¤åï¼šE æ­£ç¡®æ”¾åˆ°ä½ç½® 1 (B å‰é¢)\n`;
            result += `æ–°é¡ºåºï¼šA, E, B, C, D`;

            resultDiv.innerHTML = result;
        }

        // é‡ç½®æ¼”ç¤º
        function resetDemo() {
            const items = ['Item A', 'Item B', 'Item C', 'Item D', 'Item E'];
            const demoDiv = document.getElementById('drag-demo');
            
            demoDiv.innerHTML = '';
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'drag-item';
                div.setAttribute('data-index', index);
                div.textContent = item;
                demoDiv.appendChild(div);
            });

            const resultDiv = document.getElementById('simulation-result');
            resultDiv.style.display = 'none';
        }

        // æ˜¾ç¤ºä¿®å¤ä»£ç 
        function showFixedCode() {
            const resultDiv = document.getElementById('fix-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';

            const fixedCode = `// ä¿®å¤åçš„ insertItemAtPosition å‡½æ•°
async insertItemAtPosition(draggedItem, insertInfo) {
  const { targetItem, insertBefore } = insertInfo;
  
  console.log('ğŸ¯ æ‹–æ”¾è°ƒè¯•ä¿¡æ¯:');
  console.log('æ‹–åŠ¨é¡¹:', draggedItem.title, 'ç´¢å¼•:', draggedItem.index);
  console.log('ç›®æ ‡é¡¹:', targetItem.title, 'ç´¢å¼•:', targetItem.index);
  console.log('æ’å…¥ä½ç½®:', insertBefore ? 'å‰é¢' : 'åé¢');

  // è·å–ç›®æ ‡é¡¹ç›®çš„ç´¢å¼•
  let targetIndex = parseInt(targetItem.index) || 0;
  const draggedIndex = parseInt(draggedItem.index) || 0;

  // å¦‚æœæ’å…¥åˆ°åé¢ï¼Œç´¢å¼•+1
  if (!insertBefore) {
    targetIndex += 1;
  }

  console.log('åˆå§‹ç›®æ ‡ç´¢å¼•:', targetIndex);

  // å…³é”®ä¿®å¤ï¼šåªæœ‰åœ¨åŒä¸€çˆ¶çº§å†…ç§»åŠ¨ä¸”éœ€è¦è°ƒæ•´æ—¶æ‰å‡1
  if (draggedItem.parentId === targetItem.parentId) {
    // å¦‚æœæ‹–åŠ¨é¡¹åœ¨ç›®æ ‡ä½ç½®å‰é¢ï¼Œä¸”æœ€ç»ˆä½ç½®ä¼šå—åˆ°æ‹–åŠ¨é¡¹ç§»é™¤çš„å½±å“
    if (draggedIndex < targetIndex) {
      targetIndex -= 1;
      console.log('è°ƒæ•´åç´¢å¼•:', targetIndex, '(æ‹–åŠ¨é¡¹åœ¨å‰é¢ï¼Œç´¢å¼•-1)');
    }
  }

  console.log('æœ€ç»ˆç›®æ ‡ç´¢å¼•:', targetIndex);

  // ç§»åŠ¨æ‹–æ‹½é¡¹ç›®åˆ°ç›®æ ‡ä½ç½®
  await chrome.bookmarks.move(draggedItem.id, {
    parentId: targetItem.parentId,
    index: targetIndex
  });
  
  console.log('âœ… ç§»åŠ¨å®Œæˆ');
}

// ä¿®å¤åçš„ showDragInsertLine å‡½æ•° (å¢å¼ºè°ƒè¯•)
showDragInsertLine(event, targetElement, targetItem) {
  if (!this.dragInsertLine) {
    this.hideDragInsertLine();
    return;
  }

  const rect = targetElement.getBoundingClientRect();
  const mouseX = event.clientX;
  const elementCenterX = rect.left + rect.width / 2;

  // åˆ¤æ–­æ’å…¥ä½ç½®ï¼šé¼ æ ‡åœ¨å…ƒç´ å·¦åŠéƒ¨åˆ†æ’å…¥åˆ°å‰é¢ï¼Œå³åŠéƒ¨åˆ†æ’å…¥åˆ°åé¢
  const insertBefore = mouseX < elementCenterX;
  
  console.log('ğŸ–±ï¸ é¼ æ ‡ä½ç½®è°ƒè¯•:');
  console.log('é¼ æ ‡X:', mouseX);
  console.log('å…ƒç´ ä¸­å¿ƒX:', elementCenterX);
  console.log('æ’å…¥ä½ç½®:', insertBefore ? 'å‰é¢' : 'åé¢');

  // è®¡ç®—æ’å…¥çº¿ä½ç½®
  let lineX;
  if (insertBefore) {
    lineX = rect.left - 2; // æ’å…¥åˆ°ç›®æ ‡å…ƒç´ å·¦ä¾§
  } else {
    lineX = rect.right - 1; // æ’å…¥åˆ°ç›®æ ‡å…ƒç´ å³ä¾§
  }

  // è®¾ç½®æ’å…¥çº¿æ ·å¼å’Œä½ç½®ï¼ˆå‚ç›´çº¿ï¼‰
  this.dragInsertLine.style.left = lineX + 'px';
  this.dragInsertLine.style.top = rect.top + 'px';
  this.dragInsertLine.style.height = rect.height + 'px';
  this.dragInsertLine.classList.add('visible');

  // å­˜å‚¨æ’å…¥ä¿¡æ¯
  this.dragInsertInfo = {
    targetItem,
    insertBefore,
    targetElement
  };
  
  console.log('ğŸ’¾ å­˜å‚¨æ’å…¥ä¿¡æ¯:', this.dragInsertInfo);
}`;

            resultDiv.innerHTML = fixedCode;
        }

        // åˆå§‹åŒ–
        resetDemo();
    </script>
</body>
</html>
